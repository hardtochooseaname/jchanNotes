# top 命令

## 解读 top 输出

当你运行 `top` 命令时，它会实时动态地显示系统进程的信息。输出通常分为两个主要区域：

### **1. 概要信息区（最上面的几行）：** 

这个区域提供了系统当前状态的概览。

- **`top - <时间> up <运行时间>, <用户数> user, load average: <1分钟>, <5分钟>, <15分钟>`:**
  - **`top - <时间>`:** 当前系统时间。
  - **`up <运行时间>`:** 系统已经运行了多长时间。
  - **`<用户数> user`:** 当前登录系统的用户数量。
  - **`load average: <1分钟>, <5分钟>, <15分钟>`:** 最近 1 分钟、5 分钟和 15 分钟的平均负载。负载是指处于可运行状态（正在运行或等待运行）的进程数。如果负载持续高于 CPU 核心数，可能表示系统过载。
- **`Tasks: <总进程数> total, <运行> running, <睡眠> sleeping, <停止> stopped, <僵尸> zombie`:**
  - **`<总进程数> total`:** 系统管理的总进程数。
  - **`<运行> running`:** 当前正在 CPU 上运行的进程数。
  - **`<睡眠> sleeping`:** 处于空闲状态，等待事件发生的进程数。
  - **`<停止> stopped`:** 被信号停止的进程数（通常是用户操作）。
  - **`<僵尸> zombie`:** 已经结束但父进程尚未回收的进程。大量的僵尸进程可能表示存在问题。
- **`%Cpu(s): <用户> us, <系统> sy, <低优先级> ni, <空闲> id, <等待I/O> wa, <硬中断> hi, <软中断> si, <被盗> st`:**
  - **`<用户> us` (%user):** 用户态进程消耗的 CPU 时间百分比。
  - **`<系统> sy` (%sys, %system):** 内核态进程消耗的 CPU 时间百分比。
  - **`<低优先级> ni` (%nice):** 以较低优先级运行的用户态进程消耗的 CPU 时间百分比。
  - **`<空闲> id` (%idle):** CPU 处于空闲状态的时间百分比。数值越高越好。
  - **`<等待I/O> wa` (%wait, %iowait):** CPU 等待 I/O 操作完成的时间百分比（磁盘、网络等）。数值过高可能表示 I/O 瓶颈。
  - **`<硬中断> hi` (%irq, %hardirq):** CPU 处理硬件中断的时间百分比。
  - **`<软中断> si` (%softirq):** CPU 处理软件中断的时间百分比。
  - **`<被盗> st` (%steal):** 在虚拟化环境中，被其他虚拟机占用的 CPU 时间百分比。
- **`KiB Mem : <总内存> total, <空闲内存> free, <已用内存> used, <缓冲/缓存> buff/cache`:**
  - **`<总内存> total`:** 物理内存总量。
  - **`<空闲内存> free`:** 当前空闲的物理内存量。
  - **`<已用内存> used`:** 当前被进程使用的物理内存量。
  - **`<缓冲/缓存> buff/cache`:** 用于磁盘 I/O 缓冲和文件缓存的内存量。这部分内存在需要时可以被应用程序回收，通常被认为是“可用”的。
- **`KiB Swap: <总交换空间> total, <空闲交换空间> free, <已用交换空间> used, <可用内存> avail Mem`:**
  - **`<总交换空间> total`:** 交换空间总量。
  - **`<空闲交换空间> free`:** 当前空闲的交换空间量。
  - **`<已用交换空间> used`:** 当前正在使用的交换空间量（当物理内存不足时使用）。过度使用交换空间会显著降低系统速度。
  - **`<可用内存> avail Mem`:** 估计可用于启动新应用程序的内存量，而不会导致系统进入交换。它考虑了空闲内存和可回收的缓冲/缓存。

### **2. 任务信息区（概要信息区下方）：** 

这个区域显示了各个进程的详细信息。显示的列可以自定义，但常见的列包括：

- **`PID`:** 进程 ID，每个进程的唯一标识符。
- **`USER`:** 进程所有者的用户名。
- **`PR`:** 进程优先级。数值越低通常优先级越高。
- **`NI`:** Nice 值，影响进程优先级。负值表示更高的优先级。
- **`VIRT`:** 进程使用的虚拟内存总量（包括已分配但可能不在物理内存中的内存）。
- **`RES`:** 驻留内存，进程当前使用的非交换物理内存量。这是衡量进程实际内存消耗的好指标。
- **`SHR`:** 进程使用的共享内存量。
- **`S`:** 进程状态（例如，`S` 表示睡眠，`R` 表示运行，`Z` 表示僵尸）。
- **`%CPU`:** 进程当前使用的 CPU 时间百分比。
- **`%MEM`:** 进程当前使用的物理内存百分比。
- **`TIME+`:** 进程自启动以来累计使用的 CPU 时间（以百分之一秒为单位）。
- **`COMMAND`:** 启动进程的命令。

## **`top` 的常用操作**

当 `top` 运行时，你可以按下各种键来与其交互，更改显示或管理进程：

### general

- **`h` 或 `?`:** 显示帮助屏幕，列出所有可用的交互式命令。
- **`q`:** 退出 `top` 命令。
- **`k`:** 杀死一个进程。`top` 会提示你输入要杀死的进程的 PID 和要发送的信号（默认是 15，SIGTERM，尝试优雅地终止进程）。你可以使用 `9` (SIGKILL) 强制终止无响应的进程，但这应该是最后的手段。
- **`c`:** 切换显示命令行而不是仅仅程序名。这可以显示传递给命令的完整参数。

---

- **`n` 或 `#`:** 更改显示的进程数量。`top` 会提示你输入新的数量。
- **`f` 或 `F`:** 更改任务信息区显示的字段。你可以选择要显示的列以及它们的顺序。
- **`r`:** 重新设置进程的优先级（renice）。这允许你更改正在运行的进程的 nice 值（优先级）。`top` 会提示你输入 PID 和新的 nice 值（-20 到 19 之间的值，较低的值表示更高的优先级）。需要 root 权限才能重新设置其他用户拥有的进程或设置负 nice 值。
- **`s`:** 更改更新间隔（以秒为单位）。默认通常是 3 秒。较小的值会更频繁地更新，但会消耗更多 CPU。
- **`1`:** 切换显示每个 CPU 核心的利用率。在多核系统中，这将分别显示每个核心的利用率。
- **`<空格>`:** 强制立即更新显示。

### 排序

- **`M`:** 按内存使用量（降序）排序进程。
- **`P`:** 按 CPU 使用率（降序）排序进程。通常是默认排序方式。
- **`T`:** 按 CPU 时间（降序）排序进程。

### 过滤

- **`u`:** 按用户过滤进程。`top` 会提示你输入用户名。
- **`o` 或 `O`:** 按指定字段（值）过滤进程，可以允许按 PID 或者 COMMAND 来精准查找想要的进程。

## **如何有效地使用 `top`：**

- **识别资源密集型进程：** 关注 `%CPU` 和 `%MEM` 列，查看哪些进程消耗最多的系统资源。
- **监控系统负载：** 负载平均值提供了系统整体活动情况的指示。
- **检查内存使用情况：** 观察 `Mem` 和 `Swap` 部分，确保系统没有耗尽内存或过度使用交换空间。
- **故障排除：** 当系统性能不佳时，使用 `top` 识别失控进程或导致高 CPU 或内存利用率的进程。
- **实时监控：** 让 `top` 运行以持续查看系统性能。

