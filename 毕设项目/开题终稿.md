# 基于“事实-规划”分离记忆的长程并发协作Agent架构设计与实现

## 1. 项目背景与待解决问题

### 1.1. 项目简介

本项目旨在设计并实现一个**人机协作**的、面向长篇叙事（玄幻小说）创作的智能写作助手 Agent。与“一键生成”工具不同，本系统定位为“辅助创作”，通过与作者（用户）的深度交互，在世界观设定、大纲规划、情节推演、小说章节撰写等环节提供智能化支持。

### 1.2. 核心挑战

#### 1.2.1. 长程叙事的一致性

大型语言模型（LLM）在短文本生成上已表现出色，但在处理动辄百万字的**长程叙事（Long-Form Narrative）**时，面临着“灾难性遗忘”的根本难题。具体表现为：

- **事实遗忘：** 忘记前文设定的关键人物、世界观、物品等（“吃书”）。
- **时序混乱**：把未发生的未来规划当作已发生的既定事实，或是相反。
- **逻辑断裂：** 续写情节与前文的因果关系链断裂，人物行为（OOC）不符合既定性格。
- **伏笔失效：** 无法在后期情节中，有意识地呼应和“回收”前期铺设的悬念和伏笔。

传统的向量数据库（VectorDB）RAG 方法，通过检索“相似”文本片段来缓解遗忘，但它无法区分“已发生的事实”和“规划中的情节”，也难以理解复杂的因果和时序关系，无法从根本上解决长程一致性问题。

#### 1.2.2. 人机交互中并发任务的上下文污染

在长时程的人机协作任务中，人机交互的**频率高、时间长、任务多**，用户的任务需求通常不是线性地执行完一个任务再执行下一个，而是并发地在一个时间段中同时有多个正在讨论的任务。例如，我们可能在讨论长期大纲的时候，会引入多个新角色，那么很可能用户需要一边讨论新长线情节的同时，一遍穿插着讨论各个人物的详细信息。而某个时刻在构思人物性格的时候，用户可能又想到了短期大纲的某些情节。那么就相当于，在一个时间段内，Agent 系统穿插交错地并行执行了：构思长期大纲、构思多个人物、构思短期大纲情节多个任务。这样的并发交互任务主要会带来两个问题：

1. 对于用户输入，Agent 难以准确判断用户输入的意图，不知道用户是想要继续之前的任务还是新开一个任务。而传统的在上下文窗口中暴力填充提示词的办法，又需要面临LLM迷失（lost in the middle）和聊天历史跳跃性与混乱性的问题。
2. 在用户结束某个任务的讨论后，Agent 需要把敲定的任务相关信息精准提取处理，然后进行持久化存储。但在一个**被多任务污染的、单一的聊天历史**中，Agent 难以准确地“归因”（Attribute）哪些对话片段属于刚刚“结算”的这个特定任务。传统方法（如对近期对话进行暴力总结或信息抽取）往往会**错误地遗漏**穿插在中间的关键信息，或**错误地包含**其他不相关任务的信息，导致持久化到记忆中的数据是残缺或错误的。



## 2. 项目目标与核心创新点

本项目研究的核心目标是设计并实现一套**健壮（Robust）**且**可扩展（Scalable）**的智能体架构，专门用于解决“1.2 核心挑战”中定义的长程叙事一致性与并发交互上下文污染两大难题。为实现此目标，本系统在架构层面引入两大核心创新：

- **创新点一（架构与算法）：异构叙事记忆中枢 (Heterogeneous Narrative Memory Hub)。**
  - **解决问题：** 彻底解决传统 RAG 混淆“素材”、“事实”和“剧本”的根本缺陷，并克服图数据库在“时序追踪”上的固有短板。
  - **实现方式：** 本创新不使用单一记忆库，而是构建一个“双图谱”异构记忆系统。其核心在于 **`事实层` (Narrative Fact Layer)**（存储“既定事实”）与 **`规划层` (Strategic Planning Layer)**（存储“未来规划”）的**严格分离**。
  - **关键设计：** 这种分离架构不仅解决了“时序混淆”问题，其精妙之处在于：“规划层”通过其 `status` 属性（如 `InProgress`）和时序性结构，充当了整个系统的**“叙事状态指针”**。它为“事实层”（一个本质上“非时序”的拓扑图）提供了精确的“时序锚点”，使系统能瞬时定位“故事当前进展”，并以此为基准，再去查询“事实层”获取“当前”所需的事实。这种“**规划即时序”**的设计，优雅地实现了结构化记忆与动态状态追踪的统一。
- **创新点二（系统与交互）：并发任务上下文管理器 (Concurrent Task Context Manager)。**
  - **解决问题：** 解决创意写作中“非线性”、“高并发”的人机交互所导致的“上下文污染”灾难。
  - **实现方式：** 本创新的核心是**系统架构**，而非单一的NLU算法。我们设计了一个“高内聚”的管理模块，该模块内部集成了“人机交互网关”、“任务历史队列库”、“任务结算器”和“上下文构建器”。该架构**在系统层面**保证了每个并发任务（如“构思情节A”、“设定人物B”）都拥有**独立的、纯净的**上下文队列和状态。
  - **技术路径：** 为驱动此架构，系统需要一个“意图识别”层。在创意写作这类**高模糊性、高风险**的交互中，依赖AI自动猜测用户意图（NLU方案）极易出错，一次错误的“任务切换”就可能导致灾难性的上下文污染。因此，本设计**优先考虑系统的“鲁棒性”与“可控性”**，采用一种**“人机协同”（Human-in-the-Loop）**的控制范式，它确保了在**交互准确性**和**系统健壮性**，为专业创作者提供了可靠的生产力工具。



## 3. 系统架构与关键模块设计

系统围绕上述两个创新点，由以下四大模块构成：

### 3.1. 模块一：异构叙事记忆中枢 (Heterogeneous Narrative Memory Hub)

本模块是解决长程一致性的基石。它不是一个单一的数据库，而是一个职责分离、能力互补的异构分层系统。我们将记忆按其“功能”分为以下五层，从核心的结构化记忆到非结构化的支撑记忆，再到动态的工作态记忆：

#### 3.1.1. 事实层 (Narrative Fact Layer)

- **用途：** **事实核查与因果推理 (Fact-Checking & Causal Reasoning)**。这是系统的“世界观底座”和“历史记录”。它只存储由用户（作者）最终确认并“结算”的、**“已经发生”**的客观事实和关系。
- **结构：** 一个高精细度、高结构化的知识图谱。
  - **技术：** Neo4j 图数据库。
  - **实体：** `(Character)`, `(Location)`, `(Item)`, `(Faction)`, `(Ability)`, `(Hook:伏笔)`...
  - **关系：** `(主角) -[:OWNS]-> (飞剑A)`，`(反派) -[:HATES {reason:"灭门"}]-> (主角)`，`(飞剑A) -[:FOUND_IN]-> (神秘山洞)`...
  - **状态（关键）：** 包含“动态”属性，尤其是针对“伏笔”等关键实体。例如：`(Hook: "玉佩的秘密") -[:HAS_STATUS]-> (Status: "Unresolved")`。当后续情节回收该伏笔时，此状态会更新为 `"Resolved"`。
- **作用：** 为 Agent 提供**100% 准确**的结构化事实依据，用于上下文检索和事实核查，从根本上解决“事实遗忘”和“逻辑断裂”问题。

#### 3.1.2. 规划层 (Strategic Planning Layer)

- **用途：** 
  - **战略规划与任务指导**：用于支持**长程任务的分级任务规划**。这是人机交互任务的“未来剧本”。它只存储由人机协作共同构思的、**“将要发生”**的情节走向和创作规划。
  - **充当“叙事状态指针”：** 本层通过其 `status` 属性（如 `InProgress`），为整个系统提供了**“时序锚点”**。它解决了“事实层”不擅长时序追踪的根本缺陷，使系统能**瞬时定位**“当前故事进展到哪里”、“即将发生什么”。它是连接“静态事实库”和“动态叙事流”的**核心时序引擎**。
- **结构：** 一个独立的、层级化和时序性的知识图谱，与“事实层”物理或逻辑隔离。
  - **技术：** Neo4j 图数据库。
  - **结构设计：**
    - **层级化：** `(GeneralOutline) -[:CONTAINS]-> (LongOutline)`，`(LongOutline) -[:CONTAINS]-> (ShortOutline)`。
    - **时序性：** `(ShortOutline)-[:FIRST_STEP]->(Step:Start)-[:NEXT]->(Step:Development)-[:NEXT]->(Step:Climax)`。
    - **并行性：** `(LongOutline)` 可以同时 `[:CONTAINS]` 两个并行的 `(ShortOutline {storyline: "Protagonist"})` 和 `(ShortOutline {storyline: "Antagonist"})`。
- **任务追踪方案：**
  - 在每条故事线/大纲上，需要实时追踪故事当前的发展状态，明确大纲上哪些任务是已完成（Completed)、哪些是正在进行（InProgress）、哪些是待完成（Pending）。
  - **实现：** 采用**数据持久化、状态动态化**的设计。当一个 `(ShortOutline)` 完成后，不删除节点，而是将其节点属性更新为 `(ShortOutline {status: "Completed"})`。
  - **作用：** Agent 通过查询节点状态（如 `status: "InProgress"`）来追踪当前任务，并通过属性（如 `storyline: "Protagonist"`）来管理并行故事线。

#### 3.1.3 语义层

用于存放长文本/文档类数据，用作**事实层的补充**和**规划层的支撑**。语义层使用向量数据库（如 ChromaDB）用作底层存储，可兼顾两种查询模式：1) 当已知元数据的精准 key 值时，可执行高速的“元数据过滤”精确查询；2) 当 key 值未知时，可执行“语义检索”进行模糊查询。

##### 设定库 (Descriptive Knowledge Base)

- **用途：** **权威事实核查 (Authoritative Fact-Checking)**。
- **存储：** *只*存储精炼的、权威的“设定词条”。例如：角色外貌设定、功法体系、世界观条目、地理环境设定等。
- **作用：** 专门响应Agent的“事实核查”意图（例如，“主角的功法*设定*是什么？”），确保返回的是唯一的、浓缩的“真相”，而非其他章节中的“提及”。

##### 原文库 (Episodic Archive)

- **用途：** 在创作具体章节时，用作**情景回顾与风格保持 (Contextual Callback & Style Cohesion)**。
- **元数据设计：** 存储的每个文本块（Chunk）都将附带丰富的元数据，用于精确检索：
  - **`chapter_id`：** 章节序号（例如 `101`），**这是唯一的锚点**，用于和“叙事事实层”的图节点 `(C:Chapter {id: 101})` 进行关联。
  - **`chapter_title`：** 章节名。
  - **`entity_list`：** 本文本块（Chunk）提及的重要实体列表（例如 `["主角A", "反派B", "飞剑C"]`）。
- **作用：** 专门响应Agent的“情景回调”意图（例如，通过元数据过滤 `entity_list` 快速定位“主角A和反派B同时出现的章节”）和“风格保持”意图（例如，通过 `chapter_id` 精确检索正在创作章节的前面5章的具体文本）。



### 3.2. 模块二：多智能体创作引擎 (Multi-Agent Creativity Engine)

#### 3.2.1. 模块定位：无状态的“创意工坊”

这是系统的**“创意执行层”**。本模块的架构定位是一个**无状态 (Stateless) 的创作工具**。它不维护任何对话历史或上下文状态，而是被**“3.3 并发任务上下文管理器”**在需要时**调用 (Invoke)**。

`3.3 管理器` 负责构建和传入一个完整的 Prompt（包含了任务历史、RAG背景等），本模块则负责执行创意生成，并 `return` 一个唯一的、格式化的结果（如章节初稿、大纲选项等）给 `3.3 管理器`。

#### 3.2.2. 内部架构：协作式 Agent 团

该模块的核心是“人机协同”，而非“全自动生成”。它内部实现了一个协作式的多智能体系统（例如，采用“头脑风暴-评审”或“生成者-评估者”模式）：

- **生产者 Agent 团 (Generators / Brainstormers)：**
  - **职责：** 负责发散创意和执行“拓写”任务。
  - **核心机制：** 生产者 Agent **具备“Agentic RAG”能力**。这意味着它在创作（思考）过程中，**并非**单次 LLM 调用，而是可以**主动、迭代地**调用工具，向“异构叙事记忆中枢”(3.1) 发起**高精度的“微观事实核查”**（例如，查询`事实层`核对角色状态，或查询`设定库`获取物品描述），以确保其生成过程的每一步都严格遵循既定事实。
- **评估者 Agent 团 (Evaluators / Reviewers)：**
  - **职责：** 负责“宏观评估”与收敛。
  - **工作流：** 负责评估 `生产者 Agent` 生成内容的“整体质量”，例如：文风是否统一、情节冲突是否足够、是否达成了“规划层”的宏观目标等。
- **输出：** 此架构最终向用户（通过 `3.3 管理器` 转发）提供多个高质量的备选方案，并支持用户反馈、多轮迭代和最终确认。



### 3.3. 模块三：并发交互调度器 (Concurrent Interaction Scheduler)

本模块是系统的**“总调度室”**，负责管理“短期工作记忆”，其核心职责是解决一开始提到的“并发任务上下文污染”问题。它在“异构叙事记忆中枢”（长期记忆）和“多智能体创作引擎”（执行层）之间搭建了一个关键的**上下文管理层**。同时本模块是系统与**用户交互的唯一接口**，是唯一有权和前端进行“读”（接收用户输入）和“写”（显示Agent输出）的模块。

首先，为清晰起见，定义以下核心概念：

- **开放的任务 (Open Task)**：指用户已经发起，正在讨论中，但尚未被“结算”（Settle）并持久化到长期记忆的任务。例如，一个正在构思中的“新人物A”。
- **关闭的任务 (Closed Task)**：指已经过用户确认“结算”的任务，其讨论成果（如“人物A”的最终设定）已被持久化到“异构叙事记忆中枢”中。
- **交互历史 (Interaction History)**：指用户与 Agent 之间的完整对话流（例如，一个包含1000轮对话的列表）。
- **任务历史队列 (Task History Queue)**：指从“交互历史”中**提取**出来的、**只属于某一个特定任务**的对话子集。例如，在1000轮总历史中，第 `10, 15, 20-25` 轮对话可能同属于“构思人物A”这个任务，它们共同组成了“人物A”的任务历史队列。
- **任务结算 (Task Settlement)**：指用户发出“关闭任务”的信号。调度器响应该信号，拉取对应的“任务历史队列”，将其交给“任务结算器”进行总结、提炼，并最终持久化到长期记忆中。
- **临时任务保留 (Temporary Task Retention)**：对于“关闭的任务”，其“任务历史队列”不会被立即清除，而是会保留一段时间（例如，24小时），以便用户可以“重启”（Restart）该任务，在其基础上继续讨论。

#### A. 人机交互网关 (HCI Gateway)

- **职责**：作为 `模块 3.3` 的**唯一 I/O 接口**，充当系统的“双向交互总线”。它全权负责处理与“前端UI”和“3.2 创作引擎”之间的**所有**数据收发，并**直接维护**“任务历史队列库”的**写入**。
- **核心工作流 (输入)：**
  1. 从前端 UI 接收 `UserInput`。
  2. 将 `UserInput` 传递给 **`B. 任务意图分类器`** 进行分析。
  3. 接收 `B. 意图分类器` 返回的“意图” (例如, `Command: NewTask` 或 `Intent: ContinueTask`)。
  4. 根据此“意图”，调用 **`E. 上下文构建器`** 来组装最终的 Prompt，同时将用户输入和判定的“意图”写入到 **`C. 任务历史队列库`** 的“当前激活队列”中，以维护对话历史的完整性。
  5. 将 Prompt 发送给 **`3.2 多智能体创作引擎`** 并等待其响应。
- **核心工作流 (输出)：**
  1. 从 **`3.2 多智能体创作引擎`** 接收 `AgentOutput`。
  2. 将 `AgentOutput` **写入**到 **`C. 任务历史队列库`** 的“当前激活队列”中，以维护对话历史的完整性。
  3. 同时，将 `AgentOutput` **转发**到前端 UI 进行显示。

#### B. 任务意图分类器 (Task Intent Classifier)

- **职责**：作为系统的“意图识别”层，负责**捕获用户的任务状态变更意图**。
- **技术路线分析：**
  - 在本系统的并发交互场景中，要准确捕获用户的意图（如“新建”、“切换”、“结算”），存在两条主要的技术路线：
  - **1. AI 意图分类器（NLU 方案）：**
    - **优势：** 理想的用户体验。系统通过自然语言理解（NLU）实时监控用户输入，自动、精准地判断用户意图，实现无缝的上下文切换。
    - **挑战：** **高风险，高难度**。在长时程、多任务混杂的模糊对话中，实现高召回率和高准确率的意图识别本身就是一个前沿的科研难题，极易出错，导致系统鲁棒性降低。
  - **2. 显式人机控制（HCI 方案）：**
    - **优势：** **100% 的鲁棒性与准确性**。系统不依赖AI的“猜测”，而是通过前端 UI 提供一组明确的控制命令（如按钮或下拉菜单），由用户（作者）主动发起任务状态变更。
    - **挑战：** 需要用户付出额外的交互成本（点击操作），但是对于一个内容创作者来说是完全可以接受的。
- **当前方案选型：**
  - 考虑到本毕业设计的**核心创新点在于“记忆架构”与“系统鲁棒性”**，而非 NLU 算法本身，因此决定采用“**显式人机控制（HCI）**”方案作为系统的基础实现。
  - 这一选型确保了系统在并发交互处理上**无歧义、100% 可靠**。同时，该方案所产生的 `(用户输入, 上下文, 显式控制命令)` 数据对，是**完美的高质量标注数据**，为系统未来（Future Work）升级，去训练一个专用的“AI意图分类器”提供了清晰、可行的数据基础。
- **核心功能：** 当没有收到任何指令时，控制器默认执行**“继续当前任务”**。当收到指令时，它执行以下四种状态变更：
  - **新建任务**：`[开始新任务：规划短期大纲]`
  - **重启旧任务**：`[重启任务：设定人物“张三”]`
  - **切换任务**：`[切换至任务：规划短期大纲]`
  - **结算任务**：`[结算并关闭任务：设定人物“张三”]`

#### C. 任务历史队列库 (Task History Queue Store)

- **职责：** 作为系统的“短期工作记忆”，为每一个“开放的”和“临时保留的”任务，维护一个独立的、干净的对话历史子集（Queue）。
- **定位：** 本模块**不属于**“异构叙事记忆中枢”。记忆中枢 (3.1) 存储的是**持久化、结构化**的“长期知识”；本模块存储的是**易失性、非结构化**的“短期对话上下文”。
- **技术选型：** 可采用高性能的内存数据库（如 **Redis**）或应用层内存中的字典对象来实现。

#### D. 任务结算器 (Task Settlement Processor)

- **触发：** 当“交互状态控制器”(A) 接收到用户的 `[结算任务]` 指令时触发。
- **职责：** 负责将一个“开放任务”的非结构化讨论，转化为结构化的“长期记忆”。
  - 从“任务历史队列库”(B) 中，拉取该任务**完整**的“任务历史队列”。
  - 调用“多智能体创作引擎”(3.2)（或一个专用的总结Agent），将这个（可能很长的）历史队列作为输入，进行**总结和信息提取**，将其格式化为标准的持久化数据（例如，一个符合“叙事事实层”Schema 的 JSON 或 Cypher 语句）。
  - **（关键步骤）** 将提取出的结构化结果，通过 UI 界面**回显给用户进行最终确认**。
  - 经用户确认（或修改后确认）无误后，将该数据交给“异构叙事记忆中枢”(3.1) 进行持久化写入（例如，写入“事实层”或“规划层”）。

#### E. 上下文构建器 (Context Builder)

- **职责：** 解耦“上下文构建”与“创意生成”两个环节。本模块接收“人机交互网关”的指令，负责从“任务历史队列库”和“记忆中枢”拉取信息，**组装**成最终的、用于 LLM 的 Prompt 上下文。
- **具体功能：**
  - **继续当前任务：** 将最新的用户/AI 对话追加（Append）到当前任务的历史队列中。为防止上下文溢出，本模块会采用**滑动窗口与总结**策略（例如，保留最近K轮对话，并将其余的旧对话动态总结为一个“历史摘要”）。
  - **新建任务：** 提供一个空的任务历史队列。同时，它会根据新任务的初始描述，通过**多源RAG路由策略**到“异构叙事记忆中枢”(3.1) 进行一次**“宽泛上下文检索”**（例如，检索相关的世界观设定、父级大纲等），为新讨论提供一个丰富的背景起点。
  - **重启旧任务：** 从“队列库”(B) 拉取被“临时保留”的旧任务历史。本模块会**重新总结**这段历史（可能已过时），并**再次执行一次“宽泛上下文检索”**，以确保重启的讨论是基于最新的“事实”（例如，旧任务讨论的角色A，在A被关闭后，又在别的任务中被修改了）。
  - **切换任务：** 从“队列库”(B) 拉取目标任务的完整历史队列，并采用“继续当前任务”中的**滑动窗口与总结**策略来构建上下文，确保上下文的即时性和相关性。
  - **结算任务：**绕过所有“总结”策略，**直接拉取该任务 100% 完整、未删减**的“任务历史队列”，并将其完整地交给“任务结算器”(C)，以确保信息提取的最高保真度。

