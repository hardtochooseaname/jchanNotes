# 基础技术探索与原型验证

## git

学习并熟练一个适合我这个项目的git工作流

## 记忆系统

### 图数据库

- 选型。确认neo4j是不是最优选择
- 数据库设计的安全性和鲁棒性。由于所有cypher语句都是AI生成的，所以需要限制错误cypher语句的影响范围，防止一条错误的指令就破环掉整个数据库。
- 两个图谱是否关联？

#### 读数据库

- 规划层：无非就是读取出整条链







# 任务管理架构设计

## 任务历史队列设计

**概念澄清：**

- **父任务**：如果某个任务A是基于某个更大任务P的背景，那么说这个任务P是任务A的父任务。

### 具体结构

元数据：每条任务队列需要一些元数据用于记录任务相关的信息

- 任务名（**可供修改** - 不能重复- 唯一标识）
- 任务id（唯一标识）

**内容数据**：任务历史队列中需要存两类信息：

- **任务背景**，是单条数据。例如：短期大纲的背景是长期大纲，人物设定的背景是人物所处的短期大纲。
- **任务聊天历史**，由多条对话历史记录构成。

### 关联的行为

#### 任务背景更新

当任务结算时，需要根据结算结果，更新（追加）任务的历史。目的是实时**保持任务背景的最新状态**，其实也是实时**维护任务的执行状态**。

便于下次任务重启时可以快速感知到任务执行进度，从而**无缝继续后续讨论**。

#### 新建任务

实际上就是新建一条任务历史队列。

但是，新建的任务可能是有紧密关联的父任务的，所以需要允许新建任务直接**借用其父任务的任务背景**。





# 记忆中枢架构设计

- **事实层**存放从已发布章节中提取的稠密知识图谱。
- **已规划但未出场**的实体，存放在**规划层**，统一链接到对应大纲的头节点。
- **规划层**主要是对情节的规划，情节以时间线的顺序连成单向链表。
- **规划层和事实层通过关键实体节点互联**。规划层中与情节紧密相关的实体，都会建立从规划情节到实体节点的连接。例如，在规划层中的某个情节是关于某个关键人物的，那么这个情节节点会连接到事实层的人物节点中。这是为了便于快速获得规划情节的补充细节。

- 规划层的每条大纲线，需要有一个**头节点**，不存放具体情节信息，存放关于整条大纲线的整体设计。大致包含：

  - 出场人物或实体

  - 大概故事描述（点明这条故事线中，主角需要达成的阶段性**目标**）

  - 关键矛盾点（故事的焦点、情节发展的推动点/原因、人物行为的动机来源）


## 总体架构

1. **存储层**：对数据库操作的抽象，对外提供数据独写接口。负责数据的预处理：
   - **格式转换**：json 和 cypher 互转
   - **节点/关系的修改逻辑（关键）**：对于属性值的更新，不可能由前端用户为每一项属性值指定执行**替换、追加还是合并**操作。所以对于属性更新操作，需要精准查找到对应的节点，然后提取出节点的属性信息，然后让LLM自己通过对比来判断对于属性需要执行哪一个操作。
2. **数据库层**：直接与具体数据库对接，实际执行数据库的连接和读写操作等



## 数据结构设计

### 规划层

#### 数据结构

**情节：以叙事六要素为核心**

- 时间
- 地点
- 人物
- 起因（矛盾冲突）
- 经过
- 结果

**人物（角色）：**

- 身份背景

- 性格
- 外貌
- 行事风格/口头禅
- 特点与擅长
- 其他





## 写 IO

#### TODO：手画控制流图

- UI端用户友好：对于UI端必须时刻记住，系统的使用者是完全不懂计算机的创作者。当【任务结算器】成功提取出json数据后，需要将提取到的 json 数据**以用户友好的方式**返回给用户确认（可以是表格形式），因为不可能给一个网文写手返回 json 格式的数据。





> 1. 【UI】用户点击**任务结算**，发起结算操作；
> 2. 【人机交互网关】接收用户输入和任务结算指令，转发给**任务意图分类器；
> 3. 【任务意图分类器】通过分析用户输入判断用户意图，即**任务类型**，并返回给**人机交互网关**；
> 4. 【人机交互网关】通知**任务结算器**执行任务结算操作；
> 5. 【任务结算器】
>    - 拉取任务历史
>    - 执行提取操作
>    - **关键一点**：
> 6. 【人机交互网关】转发提取用户友好的结果到 UI
> 7. 【UI】用户确认信息提取无误





# 记忆中枢 IO 规范与用例

**数据格式规定**：系统各模块间数据交换的格式统一定为 json 格式。

## 写 IO

- **发生的时间点**：“写”操作发生的 timing 统一是在**任务结算**时，由用户在UI的点击结算操作触发，由**任务结算器**处理。
- **上游组件**：【并发交互调度器 - 人机交互网关】
- **执行组件**：【并发交互调度器 - 任务结算器】
- **下游组件**：记忆中枢的“写组件”
- **数据来源**：对话历史/任务历史，需调用【并发交互调度器 - 任务历史队列库】

- **数据去向**：根据**任务类型**不同，提取的记忆类型不同，写入到记忆中枢的具体位置不同。

  

### 事实层 

事实层是对已发生事件的详尽记录，是直接基于已发布章节的知识图谱抽取建模。

**任务类型**：事实层的“写操作”都来自于【章节撰写】任务

**输入**：一个章节的文本

**输出**：从章节中提取出的**实体、关系及其属性**信息，以 json 格式输出。所有节点需要连接到一个**Chapter节点**，这个节点存放了章节文本在向量数据库或者文档数据库中的索引值。

**结果** ：

- 新建节点： `add_node`
- 新增/修改节点属性：  `add_property / edit_property`

#### **用例**（use cases)：

输入：

```
   “斗之力，三段！”

    望着测验魔石碑上面闪亮得甚至有些刺眼的五个大字，少年面无表情，唇角有着一抹自嘲，紧握的手掌，因为大力，而导致略微尖锐的指甲深深的刺进了掌心之中，带来一阵阵钻心的疼痛…

    “萧炎，斗之力，三段！级别：低级！”测验魔石碑之旁，一位中年男子，看了一眼碑上所显示出来的信息，语气漠然的将之公布了出来…

    中年男子话刚刚脱口，便是不出意外的在人头汹涌的广场上带起了一阵嘲讽的骚动。

    “三段？嘿嘿，果然不出我所料，这个“天才”这一年又是在原地踏步！”

    “哎，这废物真是把家族的脸都给丢光了。”

    “要不是族长是他的父亲，这种废物，早就被驱赶出家族，任其自生自灭了，哪还有机会待在家族中白吃白喝。”

    “唉，昔年那名闻乌坦城的天才少年，如今怎么落魄成这般模样了啊？”

    “谁知道呢，或许做了什么亏心事，惹得神灵降怒了吧…”

    周围传来的不屑嘲笑以及惋惜轻叹，落在那如木桩待在原地的少年耳中，恍如一根根利刺狠狠的扎在心脏一般，让得少年呼吸微微急促。

    少年缓缓抬起头来，露出一张有些清秀的稚嫩脸庞，漆黑的眸子木然的在周围那些嘲讽的同龄人身上扫过，少年嘴角的自嘲，似乎变得更加苦涩了。

    “这些人，都如此刻薄势力吗？或许是因为三年前他们曾经在自己面前露出过最谦卑的笑容，所以，如今想要讨还回去吧…”苦涩的一笑，萧炎落寞的转身，安静的回到了队伍的最后一排，孤单的身影，与周围的世界，有些格格不入。

    “下一个，萧媚！”

    听着测验人的喊声，一名少女快速的人群中跑出，少女刚刚出场，附近的议论声便是小了许多，一双双略微火热的目光，牢牢的锁定着少女的脸颊…

    少女年龄不过十四左右，虽然并算不上绝色，不过那张稚气未脱的小脸，却是蕴含着淡淡的妩媚，清纯与妩媚，矛盾的集合，让得她成功的成为了全场瞩目的焦点…

    少女快步上前，小手轻车熟路的触摸着漆黑的魔石碑，然后缓缓闭上眼睛…

    在少女闭眼片刻之后，漆黑的魔石碑之上再次亮起了光芒…

    “斗之气：七段！”

    “萧媚，斗之气：七段！级别:高级！”

    “耶！”听着测验员所喊出的成绩，少女脸颊扬起了得意的笑容…
 “啧啧，七段斗之气，真了不起，按这进度，恐怕顶多只需要三年时间，她就能称为一名真正的斗者了吧…”

    “不愧是家族中种子级别的人物啊…”

    听着人群中传来的一阵阵羡慕声，少女脸颊上的笑容更是多了几分，虚荣心，这是很多女孩都无法抗拒的诱惑…

    与平日里的几个姐妹互相笑谈着，萧媚的视线，忽然的透过周围的人群，停在了人群外的那一道孤单身影上…

    皱眉思虑了瞬间，萧媚还是打消了过去的念头，现在的两人，已经不在同一个阶层之上，以萧炎最近几年的表现，成年后，顶多只能作为家族中的下层人员，而天赋优秀的她，则将会成为家族重点培养的强者，前途可以说是不可限量。

    “唉…”莫名的轻叹了一口气，萧媚脑中忽然浮现出三年前那意气风发的少年，四岁练气，十岁拥有九段斗之气，十一岁突破十段斗之气，成功凝聚斗之气旋，一跃成为家族百年之内最年轻的斗者！

    当初的少年，自信而且潜力无可估量，不知让得多少少女对其春心荡漾，当然，这也包括以前的萧媚。

    然而天才的道路，貌似总是曲折的，三年之前，这名声望达到巅峰的天才少年，却是突兀的接受到了有生以来最残酷的打击，不仅辛辛苦苦修炼十数载方才凝聚的斗之气旋，一夜之间，化为乌有，而且体内的斗之气，也是随着时间的流逝，变得诡异的越来越少。

    斗之气消失的直接结果，便是导致其实力不断的后退。

    从天才的神坛，一夜跌落到了连普通人都不如的地步，这种打击，让得少年从此失魂落魄，天才之名，也是逐渐的被不屑与嘲讽所替代。

    站的越高，摔得越狠，这次的跌落，或许就再也没有爬起的机会。

    “下一个，萧薰儿！”

    喧闹的人群中，测试员的声音，再次响了起来。

    随着这有些清雅的名字响起，人群忽然的安静了下来，所有的视线，豁然转移。

    在众人视线汇聚之处，一位身着紫色衣裙的少女，正淡雅的站立，平静的稚嫩俏脸，并未因为众人的注目而改变分毫。

    少女清冷淡然的气质，犹如清莲初绽，小小年纪，却已初具脱俗气质，难以想象，日后若是长大，少女将会如何的倾国倾城…

    这名紫裙少女，论起美貌与气质来，比先前的萧媚，无疑还要更胜上几分，也难怪在场的众人都是这般动作。

    莲步微移，名为萧薰儿的少女行到魔石碑之前，小手伸出，镶着黑金丝的紫袖滑落而下，露出一截雪白娇嫩的皓腕，然后轻触着石碑…

    微微沉静，石碑之上，刺眼的光芒再次绽放。

    “斗之气：九段！级别：高级！”

    望着石碑之上的字体，场中陷入了一阵寂静。

    “…竟然到九段了，真是恐怖！家族中年轻一辈的第一人，恐怕非薰儿小姐莫属了。”寂静过后，周围的少年，都是不由自主的咽了一口唾沫，眼神充满敬畏…

    斗之气，每位斗者的必经之路，初阶斗之气分一至十段，当体内斗之气到达十段之时，便能凝聚斗之气旋，成为一名受人尊重的斗者！

    人群中，萧媚皱着浅眉盯着石碑前的紫裙少女，脸颊上闪过一抹嫉妒…

    望着石碑上的信息，一旁的中年测验员漠然的脸庞上竟然也是罕见的露出了一丝笑意，对着少女略微恭声道：“薰儿小姐，半年之后，你应该便能凝聚斗气之旋，如果你成功的话，那么以十四岁年龄成为一名真正的斗者，你是萧家百年内的第二人！”

    是的，第二人，那位第一人，便是褪去了天才光环的萧炎。

    “谢谢。”少女微微点了点头，平淡的小脸并未因为他的夸奖而出现喜悦，安静的回转过身，然后在众人炽热的注目中，缓缓的行到了人群最后面的那颓废少年面前…

    “萧炎哥哥。”在经过少年身旁时，少女顿下了脚步，对着萧炎恭敬的弯了弯腰，美丽的俏脸上，居然露出了让周围少女为之嫉妒的清雅笑容。

    “我现在还有资格让你怎么叫么?”望着面前这颗已经成长为家族中最璀璨的明珠，萧炎苦涩的道，她是在自己落魄后，极为少数还对自己依旧保持着尊敬的人。

    “萧炎哥哥，以前你曾经与薰儿说过，要能放下，才能拿起，提放自如，是自在人！”萧薰儿微笑着柔声道，略微稚嫩的嗓音，却是暖人心肺。

    “呵呵，自在人？我也只会说而已，你看我现在的模样，象自在人吗？而且…这世界，本来就不属于我。”萧炎自嘲的一笑，意兴阑珊的道。

    面对着萧炎的颓废，萧薰儿纤细的眉毛微微皱了皱，认真的道：“萧炎哥哥，虽然并不知道你究竟是怎么回事，不过，薰儿相信，你会重新站起来，取回属于你的荣耀与尊严…”话到此处，微顿了顿，少女白皙的俏脸，头一次露出淡淡的绯红：“当年的萧炎哥哥，的确很吸引人…”

    “呵呵…”面对着少女毫不掩饰的坦率话语，少年尴尬的笑了一声，可却未再说什么，人不风流枉少年，可现在的他，实在没这资格与心情，落寞的回转过身，对着广场之外缓缓行去…

    站在原地望着少年那恍如与世隔绝的孤独背影，萧薰儿踌躇了一会，然后在身后一干嫉妒的狼嚎声中，快步追了上去，与少年并肩而行…
```

输出：

```json
{
  "nodes": [
    {
      "id": "person_1",
      "labels": ["Person", "少年"],
      "properties": {
        "name": "萧炎",
        "斗气等级": "三段",
        "级别": "低级",
        "状态": "落魄",
        "年龄": "约15岁",
        "背景": "族长之子，曾是天才"
      }
    },
    {
      "id": "person_2",
      "labels": ["Person", "测验员"],
      "properties": {
        "角色": "中年男子",
        "态度": "漠然"
      }
    },
    {
      "id": "person_3", 
      "labels": ["Person", "少女"],
      "properties": {
        "name": "萧媚",
        "斗气等级": "七段", 
        "级别": "高级",
        "年龄": "14岁左右",
        "特征": "清纯与妩媚并存"
      }
    },
    {
      "id": "person_4",
      "labels": ["Person", "少女"],
      "properties": {
        "name": "萧薰儿",
        "斗气等级": "九段",
        "级别": "高级", 
        "气质": "清冷淡然",
        "地位": "家族年轻一辈第一人"
      }
    },
    {
      "id": "object_1",
      "labels": ["Object", "测验工具"],
      "properties": {
        "name": "测验魔石碑",
        "功能": "检测斗气等级"
      }
    },
    {
      "id": "location_1",
      "labels": ["Location"],
      "properties": {
        "name": "广场",
        "场景": "测验场地"
      }
    }
  ],
  "relationships": [
    {
      "type": "进行测验",
      "fromId": "person_1",
      "toId": "object_1",
      "properties": {
        "结果": "斗之力三段",
        "评价": "低级",
        "情绪": "痛苦自嘲"
      }
    },
    {
      "type": "公布结果", 
      "fromId": "person_2",
      "toId": "person_1",
      "properties": {
        "内容": "萧炎，斗之力，三段！级别：低级！",
        "语气": "漠然"
      }
    },
    {
      "type": "嘲讽",
      "fromId": "crowd",
      "toId": "person_1", 
      "properties": {
        "态度": "不屑嘲笑",
        "内容": "废物、丢脸"
      }
    },
    {
      "type": "进行测验",
      "fromId": "person_3",
      "toId": "object_1",
      "properties": {
        "结果": "斗之气七段", 
        "评价": "高级",
        "反应": "得意"
      }
    },
    {
      "type": "进行测验",
      "fromId": "person_4", 
      "toId": "object_1",
      "properties": {
        "结果": "斗之气九段",
        "评价": "高级",
        "成就": "家族百年内第二人"
      }
    },
    {
      "type": "关心",
      "fromId": "person_4",
      "toId": "person_1",
      "properties": {
        "态度": "尊敬鼓励", 
        "对话": "萧炎哥哥，你会重新站起来",
        "关系": "保持尊敬"
      }
    },
    {
      "type": "轻视",
      "fromId": "person_3", 
      "toId": "person_1",
      "properties": {
        "原因": "阶层不同",
        "想法": "打消过去念头"
      }
    }
  ]
}
```





### 规划层 

- **故事情节**：规划层存放的是一条条或长或短的大纲/故事线，而故事线的构成元素就是一个个情节，而情节之前有时间关系。一个个作者构思的情节连起来，就成为一条故事线。（从而实现小说创作任务的问题分解和任务规划）
- **人物或其他设定**：用户可能提前产生一些未来的人物或其他实体的构想，这些待引入的实体直接链接到大纲线的头节点上。



#### 新建大纲

**任务类型**：【新建xx大纲】任务，任务讨论结果是**一系列的情节和多个人物**

**输入**：大纲背景 + 任务对话历史中对于大纲情节的讨论。

**输出**：json格式带属性的节点和关系序列。对情节和人物总结为**节点**，具体细节都存放在**节点属性**中。情节的前后关系可以通过单向 **NEXT 边**体现。人物一边统一链接到头节点，一边链接到相关情节。

**结果** ：

- 新增节点： `add_node`
- 新增关系：`add_edge`

**用例：**

[对话历史](https://gemini.google.com/share/3727765ca062)

输出：

```json
{
  "plot_nodes": [
    {
      "plot_title": "血脉初醒",
      "location": "青阳城，葬神渊",
      "characters": ["张凡", "宿敌（王家）"],
      "cause": "家族危机，张凡为保护养父母，被宿敌打落悬崖。",
      "process": "张凡坠入“葬神渊”濒死，意外激活血脉。",
      "result": "获得金手指【九死涅槃血】，修为提升；导师【南老】残魂苏醒。"
    },
    {
      "plot_title": "离开边荒",
      "location": "青阳城",
      "characters": ["张凡", "玄火门（上级势力）执事", "林清雪（引路人）"],
      "cause": "张凡复仇，引来宿敌背后的宗门势力“玄火门”追杀。",
      "process": "张凡越级反杀执事，但也彻底暴露。偶遇的林清雪提供了上级宗门的线索。",
      "result": "获得【缥缈宗考核令牌】，被迫离开边荒，前往【苍云州】。"
    },
    {
      "plot_title": "入门风波",
      "location": "苍云州，缥缈宗",
      "characters": ["张凡", "宗门内的对手（如玄火门关系户）"],
      "cause": "参加缥缈宗入门考核，遭人暗算和打压。",
      "process": "张凡在考核中置之死地而后生，反杀对手，展露天赋。",
      "result": "【血脉】再次精进，被长老破格收入【缥缈宗】。"
    },
    {
      "plot_title": "荒域名额",
      "location": "缥缈宗",
      "characters": ["张凡", "宗门宿敌（如内门大师兄）"],
      "cause": "宗门大比，争夺进入【荒域】试炼的核心名额。",
      "process": "张凡在公开比试中，击败宗门宿敌，夺得首席。",
      "result": "获得进入【荒域】资格；【南老】提示荒域有【中州传送阵】线索。"
    },
    {
      "plot_title": "道骨初苏",
      "location": "荒域，某上古遗迹",
      "characters": ["张凡", "各州天骄"],
      "cause": "在荒域中被强敌追杀，争夺上古机缘。",
      "process": "张凡误入遗迹，获得一块稀有本源神物。",
      "result": "资源被【鸿蒙道骨】吸收，道骨短暂复苏，初显神威，助张凡反杀。"
    },
    {
      "plot_title": "传送中州",
      "location": "荒域，上古传送阵",
      "characters": ["张凡", "荒域强敌（或土著）"],
      "cause": "寻找并试图修复通往中州的上古传送阵。",
      "process": "修复阵法时遭遇围攻，张凡在传送启动的瞬间被重创。",
      "result": "成功传送，抵达【中州】，但身受重伤且随机降落。"
    },
    {
      "plot_title": "身世线索 (联姻节点)",
      "location": "中州某城（非张家）",
      "characters": ["张凡", "林清雪（或新红颜）", "张家嫡系（联姻对象）"],
      "cause": "红颜被逼与古族张家联姻，张凡出手阻挠。",
      "process": "张凡在联姻宴上与张家嫡系冲突，其身份信物（龙纹玉佩）被张家长辈认出。",
      "result": "【身世曝光】，被强制带回【张氏古族】。"
    },
    {
      "plot_title": "道骨激活 (大比节点)",
      "location": "张氏古族，古族大比",
      "characters": ["张凡", "张家族人", "其他古族"],
      "cause": "为获家族承认和海量资源，代表家族参加【十大古族大比】。",
      "process": "张凡在大比中夺冠，赢得进入家族禁地（如“化龙池”）的机会。",
      "result": "【鸿蒙道骨】被海量资源彻底激活，实力暴涨；获知【父母线索】（被困万界归墟）。"
    },
    {
      "plot_title": "救赎父母",
      "location": "万界归墟",
      "characters": ["张凡", "父母（张玄、姚曦）", "天尊（爪牙/分身）"],
      "cause": "深入禁地，寻找父母踪迹。",
      "process": "张凡找到被困的父母，击退镇守者，了解真相。",
      "result": "救出父母，获知【世界真相】（牧场）和【天尊】的“灭世”计划。"
    },
    {
      "plot_title": "终局对决",
      "location": "世界本源之地",
      "characters": ["张凡", "天尊（最终Boss）"],
      "cause": "阻止“天尊”的“绝望灭世”计划。",
      "process": "张凡（希望）与天尊（绝望）展开最终决战，张凡惨胜。",
      "result": "天尊临死，天空裂开，【“收割者”降临】，全书完。"
    }
  ]
}
```





#### 更新大纲

> 新建xx大纲任务可以在之后重命名为更新xx大纲任务

**任务类型**：【更新xx大纲】任务，这时用户的通常讨论的是**新增/修改/删除单个的情节或人物**。

**输入**：大纲背景 + 大纲当前状态+ 任务对话历史中对于单个情节或人物的讨论。

**输出**：对讨论到的（多个）情节的总结，情节总结为节点，情节相关细节反映到属性中。以及（各个）情节应该插入的位置

**结果** ：

- 新建节点： `add_node`
- 新增/修改节点属性：  `add_property / edit_property`



#### **用例**（use cases)：



### 语义层

用于存放长文本/文档类数据，用作**事实层的补充**和**规划层的支撑**。

##### 设定库 

- **用途：** **权威事实核查**。
- **存储：** *只*存储精炼的、权威的“设定词条”。例如：角色外貌设定、功法体系、世界观条目、地理环境设定等。

##### 原文库

- **用途：** 存储最终敲定的章节文本。在创作具体章节时，用作**情景回顾与风格保持**。

  





# 多智能体创作引擎

## MAS协作工作流

### 博弈学习/情景学习

> 目前只是一个想法

之前的想法是创作团给出多个结果，在评审团给出评价和评分后，直接返回评分最高的几个回答。

但是可以在这个工作流中增加一个 self-refine 或是 inter-reflect 的环节：

- 每个创作者在完成创作后，会以自己的回答为主，参考所有其他创作者的回答，从中借鉴可取之处来改进自己版本的回答。
- 然后，再给评审团评分排序。
- 这样的目的，是考虑到被淘汰的回答中可能也会有非常棒的点，这样可以确保劣质回答中的优质部分被尽可能保留。