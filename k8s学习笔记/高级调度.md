# 高级调度

## 污点和容忍

### 污点

给node打上污点的作用是让（某些不能容忍该污点的）pod不能在该node上运行

#### 使用场景

- **专用节点**：我们希望让某些node只分配给某些用户使用，只专用于处理某些特定的任务。例如master就是专用节点，只负责处理集群资源的调度管理。
- **配备特殊硬件的节点**：不同的节点的硬件配置不同，适用于处理不同类型的任务，因此我们希望任务能够调度到具有自己所需硬件的node上运行。例如，某些node上配备了功能强劲的GPU，那么这些node希望运行的是AI应用，如果运行其他任务则会造成GPU资源的占用和浪费。



#### 污点的类型/影响

##### NoExecute

影响的是**正在节点上运行**的pods：

- 如果 Pod 不能容忍这类污点，会马上被驱逐。
- 如果 Pod 能够容忍这类污点，但是在容忍度定义中没有指定 `tolerationSeconds`， 则 Pod 还会一直在这个节点上运行。
- 如果 Pod 能够容忍这类污点，而且指定了 `tolerationSeconds`， 则 Pod 还能在这个节点上继续运行这个指定的时间长度。 这段时间过去后，节点生命周期控制器从节点驱除这些 Pod。

##### **NoSchedule**

影响的是**正在调度**的pods，不会影响到已经在node上运行的pods。如果pod没有相应的容忍，就不会被调度到相应节点。

##### **PreferNoSchedule**

相当于弱化的NoSchedule，控制平面将**尝试**避免将不能容忍污点的 Pod 调度到相应的节点上，但不能保证完全避免。



#### 自动添加的内置污点

当某种条件为真时，节点控制器会自动给节点添加一个污点。当前内置的污点包括：

- `node.kubernetes.io/not-ready`：节点未准备好。这相当于节点状况 `Ready` 的值为 "`False`"。
- `node.kubernetes.io/unreachable`：节点控制器访问不到节点. 这相当于节点状况 `Ready` 的值为 "`Unknown`"。
- `node.kubernetes.io/memory-pressure`：节点存在内存压力。
- `node.kubernetes.io/disk-pressure`：节点存在磁盘压力。
- `node.kubernetes.io/pid-pressure`：节点的 PID 压力。
- `node.kubernetes.io/network-unavailable`：节点网络不可用。
- `node.kubernetes.io/unschedulable`：节点不可调度。
- `node.cloudprovider.kubernetes.io/uninitialized`：如果 kubelet 启动时指定了一个“外部”云平台驱动， 它将给当前节点添加一个污点将其标志为不可用。在 cloud-controller-manager 的一个控制器初始化这个节点后，kubelet 将删除这个污点。



#### kubectl taint

##### 打污点

```sh
kubectl taint node <node-name> key=value:effect
kubectl taint no <node-name> key/value:effect

kubectl taint no k8s-master node-role.kubernetes.io/master:NoExecute
```

##### 污点

```sh
kubectl taint no k8s-master node-role.kubernetes.io/master:NoSchedule-
```



### 容忍

容忍写在pod的配置文件中，与`containers`同一级

```yaml
tolerations:
- key: "key1"
  operator: "Equal"
  value: "value1"
  effect: "NoSchedule"
- key: "key2"
  operator: "Exists"
  effect: NoExecute
  tolerationSeconds: 20  # 在存在key2:NoExecute污点的节点上可以运行20s
```

一个pod可以配置多个容忍，容忍有两种类型：

- **Equal**：匹配key-value-effect都相同的污点
- **Exists**：匹配key-effect相同的污点，不管value，配置文件中也不能有value字段

#### tolerationSeconds

**完全容忍**：对于存在`NoExecute`污点的node，如果pod对其的容忍没有设置`tolerationSeconds`，那么pod可以一直在node上运行

**限定时间内容忍**：对于存在`NoExecute`污点的node，如果pod对其的容忍设置了`tolerationSeconds`属性，那么pod只会被容忍在node上运行`tolerationSeconds`指定的时间（单位是秒）