# Dockerå¸¸ç”¨å‘½ä»¤

Docker å¸¸ç”¨å‘½ä»¤å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªä¸»è¦ç±»åˆ«ï¼Œæ¶µç›–äº†é•œåƒã€å®¹å™¨ã€ç½‘ç»œã€æ•°æ®å·ç­‰å¸¸è§æ“ä½œï¼š

## ğŸ³ ä¸€ã€é•œåƒç›¸å…³

| å‘½ä»¤                            | è¯´æ˜                                       |
| ------------------------------- | ------------------------------------------ |
| `docker pull <é•œåƒ>`            | æ‹‰å–é•œåƒï¼ˆå¦‚ï¼š`docker pull ubuntu`ï¼‰       |
| `docker images`                 | æŸ¥çœ‹æœ¬åœ°é•œåƒåˆ—è¡¨                           |
| `docker rmi <é•œåƒ>`             | åˆ é™¤é•œåƒï¼ˆå¦‚ï¼š`docker rmi ubuntu:latest`ï¼‰ |
| `docker build -t <åç§°:æ ‡ç­¾> .` | ä½¿ç”¨ Dockerfile æ„å»ºé•œåƒ                   |
| `docker tag <æºé•œåƒ> <æ–°æ ‡ç­¾>`  | ç»™é•œåƒæ‰“æ ‡ç­¾                               |

## ğŸ§± äºŒã€å®¹å™¨ç®¡ç†

| å‘½ä»¤                            | è¯´æ˜                                                  |
| ------------------------------- | ----------------------------------------------------- |
| `docker run [é€‰é¡¹] <é•œåƒ>`      | åˆ›å»ºå¹¶å¯åŠ¨å®¹å™¨ï¼ˆå¦‚ï¼š`docker run -it ubuntu bash`ï¼‰    |
| `docker ps`                     | æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨                                    |
| `docker ps -a`                  | æŸ¥çœ‹æ‰€æœ‰å®¹å™¨ï¼ˆåŒ…æ‹¬å·²åœæ­¢ï¼‰                            |
| `docker start <å®¹å™¨å/ID>`      | å¯åŠ¨å·²åœæ­¢çš„å®¹å™¨                                      |
| `docker stop <å®¹å™¨å/ID>`       | åœæ­¢è¿è¡Œä¸­çš„å®¹å™¨                                      |
| `docker restart <å®¹å™¨å/ID>`    | é‡å¯å®¹å™¨                                              |
| `docker rm <å®¹å™¨å/ID>`         | åˆ é™¤å®¹å™¨ï¼ˆéœ€å…ˆåœæ­¢ï¼‰                                  |
| `docker exec -it <å®¹å™¨> <å‘½ä»¤>` | åœ¨è¿è¡Œä¸­çš„å®¹å™¨ä¸­æ‰§è¡Œå‘½ä»¤ï¼ˆå¦‚ï¼šè¿›å…¥å®¹å™¨ï¼‰              |
| `docker attach <å®¹å™¨å/ID>`     | è¿æ¥åˆ°å®¹å™¨æ§åˆ¶å°ï¼ˆä¸æ¨è detach æ—¶ä½¿ç”¨ Ctrl + P + Qï¼‰ |

## ğŸ“¦ ä¸‰ã€æ•°æ®å·ï¼ˆVolumesï¼‰

| å‘½ä»¤                              | è¯´æ˜                     |
| --------------------------------- | ------------------------ |
| `docker volume create <åç§°>`     | åˆ›å»ºæ•°æ®å·               |
| `docker volume ls`                | æŸ¥çœ‹æ‰€æœ‰æ•°æ®å·           |
| `docker volume inspect <åç§°>`    | æŸ¥çœ‹å·è¯¦æƒ…               |
| `docker volume rm <åç§°>`         | åˆ é™¤å·                   |
| `docker run -v <å·å>:<å®¹å™¨è·¯å¾„>` | ä½¿ç”¨å·æŒ‚è½½æ•°æ®ï¼ˆæŒä¹…åŒ–ï¼‰ |

## ğŸŒ å››ã€ç½‘ç»œç®¡ç†

| å‘½ä»¤                                | è¯´æ˜                 |
| ----------------------------------- | -------------------- |
| `docker network ls`                 | æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨         |
| `docker network create <åç§°>`      | åˆ›å»ºè‡ªå®šä¹‰ç½‘ç»œ       |
| `docker network inspect <åç§°>`     | æŸ¥çœ‹ç½‘ç»œè¯¦æƒ…         |
| `docker run --network <åç§°> ...`   | æŒ‡å®šå®¹å™¨æ‰€è¿æ¥çš„ç½‘ç»œ |
| `docker network connect/disconnect` | è¿æ¥/æ–­å¼€å®¹å™¨ä¸ç½‘ç»œ  |

## ğŸ› ï¸ äº”ã€ç³»ç»Ÿä¿¡æ¯ä¸æ¸…ç†

| å‘½ä»¤                  | è¯´æ˜                                 |
| --------------------- | ------------------------------------ |
| `docker info`         | æŸ¥çœ‹ Docker ç³»ç»Ÿä¿¡æ¯                 |
| `docker version`      | æŸ¥çœ‹ Docker ç‰ˆæœ¬                     |
| `docker stats`        | æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨æƒ…å†µ                 |
| `docker system df`    | æŸ¥çœ‹ç£ç›˜ç©ºé—´ä½¿ç”¨                     |
| `docker system prune` | æ¸…ç†æ— ç”¨çš„é•œåƒã€å®¹å™¨ã€ç½‘ç»œç­‰ï¼ˆæ…ç”¨ï¼‰ |

------

## ğŸ“ ç¤ºä¾‹ï¼šå¯åŠ¨ä¸€ä¸ªå¸¦å·å’Œç«¯å£æ˜ å°„çš„å®¹å™¨

```bash
docker run -d -p 8080:80 -v mydata:/data --name web nginx
```

è¯´æ˜ï¼šåå°å¯åŠ¨ nginx å®¹å™¨ï¼Œå°†ä¸»æœº 8080 æ˜ å°„åˆ°å®¹å™¨ 80ï¼ŒæŒ‚è½½å· `mydata` åˆ°å®¹å™¨ `/data` è·¯å¾„ã€‚



# docker run

### **1. åŸºç¡€æ§åˆ¶å‚æ•°**

|     å‚æ•°     |              è¯´æ˜              |                 ç¤ºä¾‹                  |
| :----------: | :----------------------------: | :-----------------------------------: |
|   **`-d`**   | åå°è¿è¡Œå®¹å™¨ï¼ˆdetached modeï¼‰  |         `docker run -d nginx`         |
| **`--name`** |          æŒ‡å®šå®¹å™¨åç§°          |  `docker run --name my-nginx nginx`   |
|  **`--rm`**  | å®¹å™¨é€€å‡ºåè‡ªåŠ¨åˆ é™¤ï¼ˆæµ‹è¯•å¸¸ç”¨ï¼‰ | `docker run --rm alpine echo "hello"` |
|  **`-it`**   |    äº¤äº’å¼è¿è¡Œï¼ˆåˆ†é…ä¼ªç»ˆç«¯ï¼‰    |     `docker run -it ubuntu bash`      |

------

### **2. ç½‘ç»œä¸ç«¯å£æ˜ å°„**

|      å‚æ•°       |                   è¯´æ˜                   |                ç¤ºä¾‹                 |
| :-------------: | :--------------------------------------: | :---------------------------------: |
|    **`-p`**     |    ç«¯å£æ˜ å°„ï¼ˆ`å®¿ä¸»æœºç«¯å£:å®¹å™¨ç«¯å£`ï¼‰     |    `docker run -p 8080:80 nginx`    |
| **`--network`** |               æŒ‡å®šç½‘ç»œæ¨¡å¼               |  `docker run --network=host nginx`  |
|  **`--link`**   | è¿æ¥å…¶ä»–å®¹å™¨ï¼ˆå·²è¿‡æ—¶ï¼Œæ¨èç”¨è‡ªå®šä¹‰ç½‘ç»œï¼‰ | `docker run --link redis:redis app` |

------

### **3. ç¯å¢ƒå˜é‡ä¸é…ç½®**

|       å‚æ•°       |                è¯´æ˜                 |                ç¤ºä¾‹                 |
| :--------------: | :---------------------------------: | :---------------------------------: |
|     **`-e`**     |            è®¾ç½®ç¯å¢ƒå˜é‡             |  `docker run -e MY_VAR=value app`   |
| **`--env-file`** |         ä»æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡          |  `docker run --env-file=.env app`   |
|     **`-v`**     | æŒ‚è½½æ•°æ®å·ï¼ˆ`å®¿ä¸»æœºè·¯å¾„:å®¹å™¨è·¯å¾„`ï¼‰ | `docker run -v /data:/app/data app` |

------

### **4. èµ„æºé™åˆ¶**

|      å‚æ•°       |          è¯´æ˜           |               ç¤ºä¾‹                |
| :-------------: | :---------------------: | :-------------------------------: |
| **`--memory`**  | é™åˆ¶å†…å­˜ï¼ˆå•ä½ï¼š`m/g`ï¼‰ |  `docker run --memory=512m app`   |
|  **`--cpus`**   |      é™åˆ¶CPUæ ¸å¿ƒæ•°      |    `docker run --cpus=1.5 app`    |
| **`--restart`** |  å®¹å™¨é€€å‡ºæ—¶çš„é‡å¯ç­–ç•¥   | `docker run --restart=always app` |

------

### **5. é•œåƒä¸å‘½ä»¤æ§åˆ¶**

|        å‚æ•°        |       è¯´æ˜       |                  ç¤ºä¾‹                   |
| :----------------: | :--------------: | :-------------------------------------: |
| **`--entrypoint`** | è¦†ç›–é»˜è®¤å…¥å£å‘½ä»¤ | `docker run --entrypoint=/bin/bash app` |
| **`-v`** (é•œåƒå·)  |  æŒ‚è½½é•œåƒä¸­çš„å·  |        `docker run -v /data app`        |
|    **`--pull`**    | å¼ºåˆ¶æ‹‰å–æœ€æ–°é•œåƒ |    `docker run --pull=always nginx`     |



# dockerå®æˆ˜

## é•œåƒ

### é•œåƒæ‰“åŒ…ä¸åŠ è½½

```sh
# åœ¨æºæœºå™¨æ‰§è¡Œ
docker save -o my-app.tar my-app:v1
scp my-app.tar ubuntu@192.168.1.100:/home/ubuntu/

# åœ¨ç›®æ ‡æœºå™¨æ‰§è¡Œ
ssh ubuntu@192.168.1.100
docker load -i /home/ubuntu/my-app.tar
docker run -d --name app my-app:v1
```



## è¿ç»´

**å®šæœŸæ‰§è¡Œ `docker system prune -f`å’Œ `docker builder prune -f`æ˜¯ Docker ç»´æŠ¤çš„æœ€ä½³å®è·µ**ï¼Œç‰¹åˆ«æ˜¯åœ¨é¢‘ç¹æ„å»ºé•œåƒçš„å¼€å‘ç¯å¢ƒä¸­ã€‚

### ä¸ºä»€ä¹ˆåº”è¯¥ç»å¸¸æ‰§è¡Œï¼š

1. ç£ç›˜ç©ºé—´ç®¡ç†ï¼š
   - Docker ä¼šç§¯ç´¯å¤§é‡æ‚¬ç©ºé•œåƒã€å®¹å™¨å’Œç¼“å­˜
   - ä¸€ä¸ªä¸­å‹é¡¹ç›®æ¯æœˆå¯ç§¯ç´¯ 10-50GB æ— ç”¨æ•°æ®
   - å®šæœŸæ¸…ç†å¯èŠ‚çœ 30-70% çš„ Docker ç£ç›˜ç©ºé—´
2. æ€§èƒ½ä¼˜åŒ–ï¼š
   - å‡å°‘ Docker å®ˆæŠ¤è¿›ç¨‹çš„èµ„æºå¼€é”€
   - åŠ é€Ÿé•œåƒæ„å»ºï¼ˆç¼“å­˜æ›´ç²¾ç®€ï¼‰
   - æ”¹å–„ `docker` å‘½ä»¤å“åº”é€Ÿåº¦
3. ç³»ç»Ÿç¨³å®šæ€§ï¼š
   - é˜²æ­¢ç£ç›˜ç©ºé—´è€—å°½å¯¼è‡´æ„å»ºå¤±è´¥
   - é¿å…å› ç¼“å­˜å†²çªå¯¼è‡´çš„å¥‡æ€ªæ„å»ºé”™è¯¯

#### æ¨èæ‰§è¡Œé¢‘ç‡ï¼š

| ç¯å¢ƒç±»å‹     | æ¸…ç†é¢‘ç‡           | å»ºè®®å‘½ä»¤                                            |
| ------------ | ------------------ | --------------------------------------------------- |
| å¼€å‘ç¯å¢ƒ     | æ¯æ—¥æˆ–æ¯æ¬¡é‡å¯å   | `docker system prune -f`                            |
| CI/CD æµæ°´çº¿ | æ¯æ¬¡æ„å»ºä»»åŠ¡å®Œæˆå | `docker builder prune -f --all`                     |
| ç”Ÿäº§ç¯å¢ƒ     | æ¯æœˆï¼ˆè°¨æ…æ‰§è¡Œï¼‰   | `docker system prune -f --filter until=720h`        |
| ä¸ªäººç”µè„‘     | æ¯å‘¨               | `docker system prune -f && docker builder prune -f` |

#### å®‰å…¨æ¸…ç†ç­–ç•¥ï¼š

```Bash
# å®‰å…¨æ¸…ç†æ¨¡æ¿ï¼ˆä¿ç•™æœ€è¿‘7å¤©çš„èµ„æºï¼‰
docker system prune -f --filter "until=168h"
docker builder prune -f --filter "until=168h"
```

------

### ä¸€ã€`docker system prune -f` æ·±åº¦è§£æ

**åˆ é™¤çš„å…·ä½“å†…å®¹ï¼š**

1. **åœæ­¢çš„å®¹å™¨ï¼ˆstopped containersï¼‰**
   - **äº§ç”ŸåŸå› ï¼š** `docker run` ååœæ­¢çš„å®¹å™¨ï¼Œæˆ– `docker-compose down` åçš„å®¹å™¨
   - **ä½œç”¨ï¼š** é‡Šæ”¾å®¹å™¨æ–‡ä»¶ç³»ç»Ÿå ç”¨çš„ç©ºé—´ï¼ˆæ¯ä¸ªå®¹å™¨çº¦ 50-500MBï¼‰
2. **æ‚¬ç©ºé•œåƒï¼ˆdangling imagesï¼‰**
   - **äº§ç”ŸåŸå› ï¼š**
     - æ„å»ºå¤±è´¥æ—¶çš„ä¸­é—´å±‚ï¼ˆæ˜¾ç¤ºä¸º `<none>`ï¼‰
     - é‡æ–°æ„å»ºåæ—§ç‰ˆæœ¬çš„é•œåƒå±‚
     - `docker build --no-cache` äº§ç”Ÿçš„åºŸå¼ƒå±‚
   - **ä½œç”¨ï¼š** æ¸…ç†é•œåƒæ„å»ºè¿‡ç¨‹çš„"åƒåœ¾"ï¼ŒèŠ‚çœ 50-80% çš„é•œåƒå­˜å‚¨ç©ºé—´
3. **æœªä½¿ç”¨çš„ç½‘ç»œï¼ˆunused networksï¼‰**
   - **äº§ç”ŸåŸå› ï¼š**
     - `docker network create` åˆ›å»ºä½†æœªä½¿ç”¨çš„ç½‘ç»œ
     - å®¹å™¨åˆ é™¤åé—ç•™çš„è‡ªå®šä¹‰ç½‘ç»œ
   - **ä½œç”¨ï¼š** å‡å°‘ç½‘ç»œå‘½åç©ºé—´å ç”¨ï¼Œæ”¹å–„ç½‘ç»œæ€§èƒ½
4. **æ‚¬ç©ºæ„å»ºç¼“å­˜ï¼ˆéƒ¨åˆ†ï¼‰**
   - **äº§ç”ŸåŸå› ï¼š** æ„å»ºè¿‡ç¨‹ä¸­ç”Ÿæˆçš„ä¸´æ—¶å±‚
   - **ä½œç”¨ï¼š** é‡Šæ”¾éƒ¨åˆ†æ„å»ºç¼“å­˜ç©ºé—´
5. **æœªä½¿ç”¨çš„å·ï¼ˆéœ€åŠ  `--volumes` å‚æ•°ï¼‰**
   - **äº§ç”ŸåŸå› ï¼š** å®¹å™¨åˆ é™¤åæœªæŒ‡å®š `-v` åˆ é™¤çš„å·
   - **ä½œç”¨ï¼š** æ¸…ç†æŒä¹…åŒ–æ•°æ®å ç”¨çš„ç©ºé—´

------

### äºŒã€`docker builder prune -f` æ·±åº¦è§£æ

**ä¸“é—¨é’ˆå¯¹æ„å»ºç³»ç»Ÿçš„æ¸…ç†ï¼š**

1. **æ„å»ºç¼“å­˜å±‚ï¼ˆbuild cache layersï¼‰**

   - **äº§ç”ŸåŸå› ï¼š**

     ```Dockerfile
     RUN apt-get update  # è¿™è¡Œäº§ç”Ÿçš„ç¼“å­˜å±‚
     COPY . /app         # æ–‡ä»¶å˜åŒ–ä¼šä½¿åç»­ç¼“å­˜å¤±æ•ˆ
     ```

   - **ç‰¹ç‚¹ï¼š** æ¯ä¸ª `RUN`/`COPY`/`ADD` æŒ‡ä»¤éƒ½ä¼šç”Ÿæˆç¼“å­˜å±‚

   - **ä½œç”¨ï¼š** æ¸…ç†æ— æ•ˆç¼“å­˜ï¼Œé¿å…ç¼“å­˜å†²çªå¯¼è‡´çš„æ„å»ºé”™è¯¯

2. **æºä¸Šä¸‹æ–‡ç¼“å­˜ï¼ˆsource context cacheï¼‰**

   - **äº§ç”ŸåŸå› ï¼š** `docker build` æ—¶å¤åˆ¶çš„æœ¬åœ°æ–‡ä»¶ï¼ˆå¦‚ `COPY . /app`ï¼‰
   - **ç‰¹ç‚¹ï¼š** æ–‡ä»¶å˜åŒ–ä¼šä½¿æ•´ä¸ªç¼“å­˜æ ‘å¤±æ•ˆ
   - **ä½œç”¨ï¼š** é‡Šæ”¾æ„å»ºä¸Šä¸‹æ–‡å ç”¨çš„å†…å­˜å’Œç£ç›˜ç©ºé—´

3. **å¤šé˜¶æ®µæ„å»ºä¸­é—´å±‚ï¼ˆmulti-stage intermediatesï¼‰**

   - **äº§ç”ŸåŸå› ï¼š**

     ```Dockerfile
     FROM node AS build  # è¿™ä¸ªé˜¶æ®µäº§ç”Ÿçš„ä¸­é—´é•œåƒ
     FROM nginx          # æœ€ç»ˆé˜¶æ®µ
     ```

   - **ä½œç”¨ï¼š** æ¸…ç†æœªè¢«æœ€ç»ˆé•œåƒå¼•ç”¨çš„ä¸­é—´æ„å»ºå±‚

4. **æœªæ‹‰å–çš„é•œåƒå±‚ï¼ˆunpulled image layersï¼‰**

   - **äº§ç”ŸåŸå› ï¼š** æ„å»ºè¿‡ç¨‹ä¸­ä¸‹è½½çš„åŸºç¡€é•œåƒä¸´æ—¶å±‚
   - **ä½œç”¨ï¼š** æ¸…ç†éƒ¨åˆ†ä¸‹è½½ä½†æœªä½¿ç”¨çš„é•œåƒæ•°æ®

------

### ä¸‰ã€èµ„æºäº§ç”Ÿçš„æ—¶é—´çº¿

|                   | æˆåŠŸ                       | å¤±è´¥                        |
| ----------------- | -------------------------- | --------------------------- |
| **å¼€å§‹æ„å»º**      | æ‹‰å–åŸºç¡€é•œåƒ               |                             |
|                   | æ‰§è¡Œ `RUN` å‘½ä»¤            |                             |
|                   | ç”Ÿæˆæ„å»ºç¼“å­˜               |                             |
|                   | å¤åˆ¶æ–‡ä»¶                   |                             |
|                   | åˆ›å»ºä¸­é—´å±‚é•œåƒ             |                             |
| **æ„å»ºæˆåŠŸ/å¤±è´¥** |                            |                             |
|                   | è¿è¡Œå®¹å™¨                   | äº§ç”Ÿæ‚¬ç©ºé•œåƒ                |
|                   | åœæ­¢å®¹å™¨                   |                             |
|                   | äº§ç”Ÿåœæ­¢çš„å®¹å™¨             |                             |
|                   | äº§ç”Ÿæ„å»ºç¼“å­˜               | äº§ç”Ÿæ„å»ºç¼“å­˜                |
|                   | äº§ç”Ÿæºä¸Šä¸‹æ–‡ç¼“å­˜           | äº§ç”Ÿæºä¸Šä¸‹æ–‡ç¼“å­˜            |
|                   | `docker system prune` æ¸…ç† | `docker builder prune` æ¸…ç† |

---

### å››ã€ä¸ºä»€ä¹ˆéœ€è¦åˆ†åˆ«ä½¿ç”¨ä¸¤æ¡å‘½ä»¤

1. **èŒè´£åˆ†ç¦»ï¼š**

   - `system prune`ï¼šç®¡ç†è¿è¡Œæ—¶èµ„æºï¼ˆå®¹å™¨/é•œåƒ/ç½‘ç»œï¼‰
   - `builder prune`ï¼šç®¡ç†æ„å»ºè¿‡ç¨‹èµ„æºï¼ˆç¼“å­˜/ä¸­é—´å±‚ï¼‰

2. **å­˜å‚¨ä½ç½®ä¸åŒï¼š**

   - æ„å»ºç¼“å­˜å­˜å‚¨åœ¨ `/var/lib/docker/buildkit`ï¼ˆç‹¬ç«‹äºé•œåƒå­˜å‚¨ï¼‰
   - é•œåƒæ•°æ®å­˜å‚¨åœ¨ `/var/lib/docker/overlay2`

3. **æ¸…ç†ç²’åº¦å·®å¼‚ï¼š**

   - `builder prune` å¯ç²¾ç¡®æ§åˆ¶ç¼“å­˜ä¿ç•™ç­–ç•¥ï¼š

     ```Bash
     # ä¿ç•™æœ€è¿‘2å¤©çš„ç¼“å­˜
     docker builder prune --filter until=48h
     ```

4. **æ€§èƒ½å½±å“ï¼š**

   - æ„å»ºç¼“å­˜æ¸…ç†å¯åŠ é€Ÿåç»­æ„å»ºï¼ˆå‡å°‘ç¼“å­˜éªŒè¯æ—¶é—´ï¼‰
   - ç³»ç»Ÿæ¸…ç†æ”¹å–„æ•´ä½“ Docker å®ˆæŠ¤è¿›ç¨‹æ€§èƒ½
